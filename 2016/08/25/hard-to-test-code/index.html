
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Refactoring Hard to Test Code - Hamish Rickerby</title>
  <meta name="author" content="Hamish Rickerby">

  
  <meta name="description" content="As part of the Apprenticeship, I need to create an HTTP server. The purpose of the activity is to create a relatively complex, real-world system with &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://hamishrickerby.com/2016/08/25/hard-to-test-code">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Hamish Rickerby" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<script type="text/javascript">
    var host = "hamishrickerby.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
</script>
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="/javascripts/footnote.js" type="text/javascript"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-535090-7']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Hamish Rickerby</a></h1>
  
    <h2>Technology Consultant & iOS Developer based in Sydney, Australia</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hamishrickerby.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/books">Reading List</a></li>
  <li><a href="http://twitter.com/rickerbh">Twitter</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Refactoring Hard to Test Code</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-08-25T20:47:08+10:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:47 pm</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="https://hamishrickerby.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>As part of the <a href="https://hamishrickerby.com/2016/08/20/software-apprenticeships/">Apprenticeship</a>, I need to create an <a href="https://github.com/rickerbh/http_server_java">HTTP server</a>. The purpose of the activity is to create a relatively complex, real-world system with TDD, following SOLID/clean code principles. It&rsquo;s going well so far. There is a FitNesse spec for acceptance tests that the server needs to pass, and I have to create it in Java. I&rsquo;m getting there.</p>

<p>However, I recently found that I was having to jump through some hoops to test my socket connection completion handler, and my mentor suggested this might be a code smell, and that I should look at refactoring the code to make it easier to test. <em>As an aside, I&rsquo;m using the &ldquo;new&rdquo; non-blocking IO socket classes rather than the traditional socket classes, so that multithreading should be simpler as I shouldn&rsquo;t need to manage threadpools.</em></p>

<p>The design I had come up with for handling HTTP requests and responses was quite tightly tied to the Java <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/channels/CompletionHandler.html"><code>CompletionHandler</code></a> generic interface, and specifically the <code>completed</code> method that receives <a href="https://docs.oracle.com/javase/7/docs/api/java/nio/channels/AsynchronousSocketChannel.html"><code>AsynchronousSocketChannel</code></a>s. Testing it, by generating fake <code>AsynchronousSocketChannels</code> felt super hacky. The code for dealing with processing requests and responses was also tied in with the channel handling code, so the responsibility of the class was not very clear.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HTTPCompletionHandler</span> <span class="kd">implements</span> <span class="n">CompletionHandler</span><span class="o">&lt;</span><span class="n">AsynchronousSocketChannel</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ResponseFactory</span> <span class="n">responseFactory</span><span class="o">;</span>
</span><span class='line'>    <span class="n">AsynchronousServerSocketChannel</span> <span class="n">listeningChannel</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">HTTPCompletionHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">rootDirectory</span><span class="o">,</span> <span class="n">AsynchronousServerSocketChannel</span> <span class="n">listeningChannel</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">responseFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ResponseFactory</span><span class="o">(</span><span class="n">rootDirectory</span><span class="o">);</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">listeningChannel</span> <span class="o">=</span> <span class="n">listeningChannel</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">ch</span><span class="o">,</span> <span class="n">Void</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">listeningChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">requestText</span> <span class="o">=</span> <span class="n">extractRequestText</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Request</span><span class="o">(</span><span class="n">requestText</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">responseFactory</span><span class="o">.</span><span class="na">makeResponse</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sendResponse</span><span class="o">(</span><span class="n">ch</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">closeChannel</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">failed</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">exc</span><span class="o">,</span> <span class="n">Void</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="nf">extractRequestText</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">8192</span><span class="o">);</span>
</span><span class='line'>        <span class="kt">byte</span><span class="o">[]</span> <span class="n">requestBytes</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">bytesRead</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span><span class='line'>            <span class="n">requestBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bytesRead</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">bytesRead</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
</span><span class='line'>                <span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">requestBytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytesRead</span><span class="o">);</span>
</span><span class='line'>                <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">requestBytes</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendResponse</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">ch</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ch</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">closeChannel</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">ch</span><span class="o">.</span><span class="na">isOpen</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ch</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Time to refactor</h2>

<p>Below are a series of steps that I went through to refactor this class to ensure single-responsibility, and make it significantly easier to test the functionality.</p>

<p><em>Links are provided at the end to github for the steps as commits. Github also contains the tests. 100% TDD baby!</em></p>

<h3>Create interfaces</h3>

<p>First of all, I needed to break the dependency between the HTTP Request/Repsonse code, and the <code>AsynchronousSocketChannel</code> code. I introduced an abstraction for reading and writing data.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ByteReader</span> <span class="o">{</span>
</span><span class='line'>     <span class="kt">byte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ByteWriter</span> <span class="o">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I could have put these in a single interface, but splitting them gives easier support for different implementation models, such as reading from a socket, and writing out to a file.</p>

<h3>Concrete implementations</h3>

<p>Then, implement classes that support these interfaces that use the <code>AsynchronousSocketChannel</code> to read and write from.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsynchronousSocketChannelReader</span> <span class="kd">implements</span> <span class="n">ByteReader</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">AsynchronousSocketChannel</span> <span class="n">channel</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">AsynchronousSocketChannelReader</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ByteBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocate</span><span class="o">(</span><span class="mi">8192</span><span class="o">);</span>
</span><span class='line'>        <span class="kt">byte</span><span class="o">[]</span> <span class="n">requestBytes</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="kt">int</span> <span class="n">bytesRead</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">20</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">);</span>
</span><span class='line'>            <span class="n">requestBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bytesRead</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">bytesRead</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="o">.</span><span class="na">position</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">buffer</span><span class="o">.</span><span class="na">flip</span><span class="o">();</span>
</span><span class='line'>                <span class="n">buffer</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">requestBytes</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">bytesRead</span><span class="o">);</span>
</span><span class='line'>                <span class="n">buffer</span><span class="o">.</span><span class="na">clear</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">requestBytes</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AsynchronousSocketChannelWriter</span> <span class="kd">implements</span> <span class="n">ByteWriter</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">AsynchronousSocketChannel</span> <span class="n">channel</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">AsynchronousSocketChannelWriter</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">channel</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">channel</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">bytes</span><span class="o">));</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Integrate these back in</h3>

<p>The next step is to start to use these within the <code>HTTPCompletionHandler</code> class. The bulk of the <code>extractRequestText</code> and <code>sendResponse</code> functions can also be dropped from the <code>HTTPCompletionHandler</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="nf">extractRequestText</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ByteReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AsynchronousSocketChannelReader</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendResponse</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">ch</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ch</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">()));</span>
</span><span class='line'>        <span class="n">ByteWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AsynchronousSocketChannelWriter</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code in <code>sendResponse</code> at this interim step has grown longer, but what we&rsquo;ve actually done here is enable a very clean break in the dependency between the HTTP request/response processing, and the <code>AsynchronousSocketChannel</code>, as we&rsquo;ll see in the next step.</p>

<h3>Extract HTTP Request/Response handling</h3>

<p>Now, we need to remove the HTTP Request and Response handling out of this completion handler. The completion handler will soon have a very specific responsibility in providing an interface adapter between <code>AsynchronousSocketChannel</code>s and processing that data. The reading, writing, or orchestration of the data flow will no longer be part of that classes responsibility.</p>

<p>We&rsquo;re creating a new class called <code>HTTPHandler</code>. This class will take the configuration required (a directory) on instantiation, and for each request it needs to process it&rsquo;ll receive a <code>ByteReader</code> and <code>ByteWriter</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HTTPHandler</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ResponseFactory</span> <span class="n">responseFactory</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">HTTPHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">rootDirectory</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">responseFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ResponseFactory</span><span class="o">(</span><span class="n">rootDirectory</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(</span><span class="n">ByteReader</span> <span class="n">reader</span><span class="o">,</span> <span class="n">ByteWriter</span> <span class="n">writer</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">String</span> <span class="n">requestText</span> <span class="o">=</span> <span class="n">extractRequestText</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Request</span> <span class="n">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">Request</span><span class="o">(</span><span class="n">requestText</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Response</span> <span class="n">response</span> <span class="o">=</span> <span class="n">responseFactory</span><span class="o">.</span><span class="na">makeResponse</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">sendResponse</span><span class="o">(</span><span class="n">writer</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="nf">extractRequestText</span><span class="o">(</span><span class="n">ByteReader</span> <span class="n">reader</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="nf">String</span><span class="o">(</span><span class="n">reader</span><span class="o">.</span><span class="na">read</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">sendResponse</span><span class="o">(</span><span class="n">ByteWriter</span> <span class="n">writer</span><span class="o">,</span> <span class="n">Response</span> <span class="n">response</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">writer</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">response</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The beauty in creating a class like this where the reader and writer are abstract and provided to it, is that it&rsquo;s not dependent on any particular type of Socket, or Stream, of Buffer.</p>

<h3>Fake Reader and Writer for testing</h3>

<p>The interface for these two types is very simple, and very, very, very easy to create Fake versions of to test.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FakeReader</span> <span class="kd">implements</span> <span class="n">ByteReader</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">byteData</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">FakeReader</span><span class="o">(</span><span class="n">String</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">byteData</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="na">getBytes</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">read</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">byteData</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">FakeWriter</span> <span class="kd">implements</span> <span class="n">ByteWriter</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">byteData</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">write</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">byteData</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">readWrittenBytes</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">byteData</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Remove HTTP functionality from CompletionHandler</h3>

<p>We can drop the <code>extractRequestText</code> and <code>sendResponse</code> methods from the <code>HTTPCompletionHandler</code> altogether, as these are now provided by the <code>HTTPHandler</code>.</p>

<p>The relevant parts of the <code>HTTPCompletionHandler</code> will change as below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HTTPCompletionHandler</span> <span class="kd">implements</span> <span class="n">CompletionHandler</span><span class="o">&lt;</span><span class="n">AsynchronousSocketChannel</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span class='line'><span class="n">HTTPHandler</span> <span class="n">handler</span><span class="o">;</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">HTTPCompletionHandler</span><span class="o">(</span><span class="n">String</span> <span class="n">rootDirectory</span><span class="o">,</span> <span class="n">AsynchronousServerSocketChannel</span> <span class="n">listeningChannel</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">responseFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ResponseFactory</span><span class="o">(</span><span class="n">rootDirectory</span><span class="o">);</span>
</span><span class='line'>        <span class="n">handler</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">HTTPHandler</span><span class="o">(</span><span class="n">rootDirectory</span><span class="o">);</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">listeningChannel</span> <span class="o">=</span> <span class="n">listeningChannel</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">completed</span><span class="o">(</span><span class="n">AsynchronousSocketChannel</span> <span class="n">ch</span><span class="o">,</span> <span class="n">Void</span> <span class="n">attachment</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">listeningChannel</span><span class="o">.</span><span class="na">accept</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ByteReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AsynchronousSocketChannelReader</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ByteWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">AsynchronousSocketChannelWriter</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>        <span class="n">handler</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">reader</span><span class="o">,</span> <span class="n">writer</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">closeChannel</span><span class="o">(</span><span class="n">ch</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Complete</h3>

<p>The <code>completed</code> method now only instatiates <code>ByteReader</code> and <code>ByteWriter</code>s that can handle <code>AsynchronousSocketChannel</code>s, and asks the instantiated handler to begin processing with the reader and writers.</p>

<p>The concrete <code>ByteReader</code> and <code>ByteWriter</code>s now encapsulate the logic for reading from and writing to <code>AsynchronousSocketChannel</code>s, rather than this being tied with with dealing with HTTP requests and responses.</p>

<p>The <code>HTTPHandler</code> now supports any sort of interface that can conform to <code>ByteReader</code> and <code>ByteWriter</code> for receiving and sending HTTP content.</p>

<p>And, all classes are small, all methods are small, and due to the interface abstractions, super simple to test.</p>

<h2>End</h2>

<p>Refactoring is never really over, but I hope this has been a useful example of how you could refactor a class to</p>

<ul>
<li>extract dependencies</li>
<li>provide a simpler API</li>
<li>ensure single-responsibility, and</li>
<li>make functionality easier to test</li>
</ul>


<p>If you want to see the whole refactor as a single diff, check out <a href="https://github.com/rickerbh/http_server_java/commit/d524a31562969bb39351f7cbd0567b9db503d815">this commit</a>, or if you&rsquo;re interested in seeing each individual step, check the <a href="https://github.com/rickerbh/http_server_java/commits/feature/refactor-completion-handler">last 8 commits on this branch</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Hamish Rickerby</span></span>

      




<time class='entry-date' datetime='2016-08-25T20:47:08+10:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>25</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>8:47 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://hamishrickerby.com/2016/08/25/hard-to-test-code/" data-via="rickerbh" data-counturl="https://hamishrickerby.com/2016/08/25/hard-to-test-code/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2016/08/20/software-apprenticeships/" title="Previous Post: Software Apprenticeships">&laquo; Software Apprenticeships</a>
      
      
        <a class="basic-alignment right" href="/2016/11/02/refactoring-legacy-code-gilded-rose-kata/" title="Next Post: Refactoring Legacy Code - Gilded Rose Kata">Refactoring Legacy Code - Gilded Rose Kata &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/11/02/refactoring-legacy-code-gilded-rose-kata/">Refactoring Legacy Code - Gilded Rose Kata</a>
      </li>
    
      <li class="post">
        <a href="/2016/08/25/hard-to-test-code/">Refactoring Hard to Test Code</a>
      </li>
    
      <li class="post">
        <a href="/2016/08/20/software-apprenticeships/">Software Apprenticeships</a>
      </li>
    
      <li class="post">
        <a href="/2016/08/04/interface-segregation/">Interface Segregation</a>
      </li>
    
      <li class="post">
        <a href="/2016/07/25/wrapping-3rd-party-code/">Wrapping 3rd Party Code</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/rickerbh">@rickerbh</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'rickerbh',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("rickerbh", , );
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/rickerbh">@rickerbh</a></p>
  
</section>


<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/103674783197570316138?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Hamish Rickerby -
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'itickedthewrongbox';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://hamishrickerby.com/2016/08/25/hard-to-test-code/';
        var disqus_url = 'https://hamishrickerby.com/2016/08/25/hard-to-test-code/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
