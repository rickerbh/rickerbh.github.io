
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Refactoring Legacy Code - Gilded Rose Kata - Hamish Rickerby</title>
  <meta name="author" content="Hamish Rickerby">

  
  <meta name="description" content="Often getting legacy code into a state where you&rsquo;re comfortable making changes to it can be challenging. Legacy code can often have varying &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://hamishrickerby.com/2016/11/02/refactoring-legacy-code-gilded-rose-kata">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Hamish Rickerby" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<script type="text/javascript">
    var host = "hamishrickerby.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
</script>
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="/javascripts/footnote.js" type="text/javascript"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-535090-7']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Hamish Rickerby</a></h1>
  
    <h2>Technology Consultant & iOS Developer based in Sydney, Australia</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:hamishrickerby.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/books">Reading List</a></li>
  <li><a href="http://twitter.com/rickerbh">Twitter</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Refactoring Legacy Code - Gilded Rose Kata</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-11-02T07:52:37+11:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>7:52 am</span></time>
        
           | <a href="#disqus_thread"
             data-disqus-identifier="https://hamishrickerby.com">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Often getting legacy code into a state where you&rsquo;re comfortable making changes to it can be challenging. Legacy code can often have varying levels of quality throughout the codebase, as well as different levels of testing applied to it. I&rsquo;ve taken over my fair share of old projects that have no tests, or haven&rsquo;t followed SOLID principles, and understanding how the code works and what it does can be a challenge.</p>

<p>The <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata">Gilded Rose Kata</a> is an exercise in taking a system that calculates &ldquo;quality&rdquo; and expiry dates for items in a shop over time. When you start the Kata, you have a single method that calculates the changes in quality and expiry for the items. The business logic implemented is hard to understand, and features nested <code>if</code> statements with conditionals that feel inverted. You also need to add functionality to support a new item type to the shop to complete the Kata.</p>

<p>This post will describe how I refactored the code. All code and commits are available at <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift">https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift</a></p>

<h2>My Approach</h2>

<h3>Acceptance Tests</h3>

<p>When refactoring, you&rsquo;re typically looking to improve the internal structure of the code without changing the externally observable behaviour of the system. To ensure the existing behaviour didn&rsquo;t change whilst I was refactoring, I followed the advice in the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata/blob/master/README.md">readme</a> that recommends &ldquo;Text-Based Approval Testing&rdquo;. This is essentially an acceptance test in which the behaviour of the system is captured before you start refactoring, and then while refactoring you can compare the changed systems&#8217; output with the original output.</p>

<p>To implement this, I captured the text output from running the application in a file and stored it in the repo. I then implemented a test that would replicate running the application, but storing the results in memory. Then the test compared the results of my application with the output from the original application. <em>As an aside here, when I first implemented this I did a <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/25add659ca61871fd65d5204b1ef307c3adf8fc0/GildedRoseTests/GildedRoseTests.swift">comparison of the full body</a>. I quickly found this to be a terrible solution, and then <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/commit/ea2f4273b22b1dc61e2bfbb943c8f9874b2bc523">implemented a line-by-line comparison</a> so I could easily tell what part of the calculations were going wrong. Also, I found an issue with the original project setup, so submitted an (accepted) PR to the original repo that corrected the store definintion.</em></p>

<h3>Understanding the Existing Logic</h3>

<p>I&rsquo;ve recently read <a href="http://www.bookdepository.com/Working-Effectively-with-Legacy-Code-Michael-Feathers/9780131177055?a_aid=rickerbh">Working Effectively With Legacy Code</a> by Michael Feathers and there was one approach in this book that seemed to jump out at me to help understand the Gilded Roses logic - Sprout Method. This is where you take a small block of existing functionality (e.g., an <code>if</code> statement), extract it out to it&rsquo;s own function, and give it a sensible name. Then, rather than seeing a block of code such as</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="s">&quot;Sulfuras, Hand of Ragnaros&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sellIn</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sellIn</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>you see something like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="n">decrementSellDate</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Example of this <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/commit/685e521451764d339d48849d5a9d11b02df01da5#diff-9f2a98a59f7438329af132a5cb5651e0">here</a>.</p>

<p>The behaviour of the system doesn&rsquo;t change, but suddenly it becomes more readable.  Each &ldquo;sprouted&rdquo; method is also accompanied by a test. This allows you to also validate that your extracted code will then continue to work as expected, even with other changes taking place.</p>

<p>For this refactor, I continued to write tests and extract methods to get the giant block of if statements to a <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/685e521451764d339d48849d5a9d11b02df01da5/GildedRose/GildedRose.swift">point</a> where I could understand what they were doing.</p>

<p>After this, I considered the <code>if</code> statement itself. It used a bunch of negation statements to control the flow of execution through the application e.g., <code>if (items[i].name != "Aged Brie" &amp;&amp; items[i].name != "Backstage passes to a TAFKAL80ETC concert")</code>. Personally, I find this style of <code>if</code> statement creates a higher congnitive load that &ldquo;positive&rdquo; statement, so I <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/bbd3b0c71efec492cda6cc1326954098844cab9a/GildedRose/GildedRose.swift">restructured it</a> to use statements more like <code>if (items[i].name == "Aged Brie" || items[i].name == "Backstage passes to a TAFKAL80ETC concert")</code>. Maybe that&rsquo;s a personal thing, but I find it simpler to understand - being explicit about what the predicate matches, rather than &ldquo;everything but these items&rdquo;. During this activity, having the acceptance tests run was crucial to ensure the system behaved the same, while the statements were changing.</p>

<p>After this, I extracted one more method for managing expiry dates. I felt that I had a good understanding of how the existing system worked and the logic was clear in the codebase. Time for some bigger changes.</p>

<h3>Restrictions</h3>

<p>One of the key restrictions in the Gilded Rose Kata is that you&rsquo;re not allowed to alter the <code>Items</code> class or the <code>Items</code> property. Not having this restriction would have made the refactor relatively trivial as you could just create different subclasses that represent the behavour of each of the types of items. To do this however, would have involved altering the <code>Items</code> propetry to instantiate the different item types, or turning the <code>Items</code> class into a factory that would return items of different types. So, I needed a way to move the rules for specific types of items away from the main calculation flow, so that new item types could be introduced without impacting the existing processes.</p>

<h3>Behaviours</h3>

<p>I decided to add an <code>ItemBehaviour</code> <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/533be7a6b599cbe97b2537cbed4a7e8820e63ebc/GildedRose/ItemBehaviour.swift">class</a> that would act as a superclass for each of the items to encapsualte the rules/logic for that specific item. The goal was to separates out the process of incrementing a day in the store, and how each item changes as the days increment. Then I created subclasses (<a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/142973824c68c64a637c3826f59949ac90572348/GildedRose/AgedBrieBehaviour.swift">Brie</a>, <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/a36201b42314a8c2a80c155f3e9aab72610b4e5b/GildedRose/SulfurasBehaviour.swift">Sulfuras</a>, <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/41ce082a2db297176da6dcb4ab68d663e9a3e4e4/GildedRose/BackstagePassBehaviour.swift">BackStagePass</a>) to override the default behaviour for each item that has unique logic. To surface this behaviour, a <code>BehaviourFactory</code> <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/23c09686703a0248858fef55de8fbb25bc10f96f/GildedRose/BehaviourFactory.swift">class</a> was implemented that would return an <code>ItemBehaviour</code> based on the items name (not the approach I would have liked to implement, but not being allowed to change the <code>Item</code> class is quite a restriction).</p>

<p>The behaviour was then <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/3809fe56f32c55e2b0c839a0060a16b61ebd55c4/GildedRose/GildedRose.swift">integrated</a> into the main application flow by replacing the if-statement/logic that takes place before the date change with a single call to <code>updateQualityPreDateChange</code>.</p>

<p>Next, the functionality to <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/commit/ae3a6b704a124f697778e1409d11d03d525a49de">decrement the sales date</a> was extracted from the sprouted method, and placed into the specific item behaviour classes. And finally, the changes to <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/commit/f12c0174a27e43484cc3bd23b077cc087509b94b">process expired items</a> was extracted out into the item behaviour classes.</p>

<h3>Done</h3>

<p>The main body of the store updating function has been dramatically simplified. It now <code>map</code>s through all the items, retrieves the behaviour for an item, and calls the functions to advance the item through a day. Simples.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">let</span> <span class="n">_</span> <span class="o">=</span> <span class="n">items</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">item</span> <span class="k">in</span>
</span><span class='line'>  <span class="k">let</span> <span class="n">itemBehaviour</span> <span class="o">=</span> <span class="n">BehaviourFactory</span><span class="p">.</span><span class="n">getBehaviour</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>  <span class="n">itemBehaviour</span><span class="p">.</span><span class="n">updateQualityPreDateChange</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>  <span class="n">itemBehaviour</span><span class="p">.</span><span class="n">decrementSellDate</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>  <span class="n">itemBehaviour</span><span class="p">.</span><span class="n">processExpiredItem</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I believe that&rsquo;s significantly easier to understand than the <a href="https://github.com/emilybache/GildedRose-Refactoring-Kata/blob/master/swift/Sources/GildedRose.swift">original code</a>.</p>

<h2>New Item</h2>

<p>Now that the item behaviour is decoupled from the main day-end processing, adding a new item type is trivial. The new type gets <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/188b53c4122ec2fb25e8888633acd9a72d4cee29/GildedRose/ConjuredBehaviour.swift">added</a> and then integrated into the <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/188b53c4122ec2fb25e8888633acd9a72d4cee29/GildedRose/BehaviourFactory.swift">factory</a>. The only other thing that needs to happen is the old acceptance test needs to be updated, as this item didn&rsquo;t exist in the original set. Ideally at this point the acceptance test would be updated (or removed) as the system behaviour has moved on, but for the purposes of this exercise I <a href="https://github.com/rickerbh/GildedRose-Refactoring-Kata-Swift/blob/188b53c4122ec2fb25e8888633acd9a72d4cee29/GildedRoseTests/GildedRoseTests.swift">excluded</a> the new item from the test.</p>

<h2>Wrap Up</h2>

<p>Legacy System maintenance is hard, but not impossible. You can always get a piece of business logic to be able to be tested, and restructure messy code so it&rsquo;s simple and understandable. Techniques such as sprout method make gaining initial understanding and making code a bit more clear relatively easy to perform. <a href="http://www.bookdepository.com/Working-Effectively-with-Legacy-Code-Michael-Feathers/9780131177055?a_aid=rickerbh">Working Effectively With Legacy Code</a> was a super-valuable resource, and covers many, many techniques to get an unwieldy codebase under control, both in terms of gaining understanding as well as getting code testable.</p>

<p>Personally, I found this kata a valuable experience in getting an existing system under control, whilst maintaining existing behaviour. I recommend if you have a spare hour or so give it a go yourself.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Hamish Rickerby</span></span>

      




<time class='entry-date' datetime='2016-11-02T07:52:37+11:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>7:52 am</span></time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="https://hamishrickerby.com/2016/11/02/refactoring-legacy-code-gilded-rose-kata/" data-via="rickerbh" data-counturl="https://hamishrickerby.com/2016/11/02/refactoring-legacy-code-gilded-rose-kata/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2016/08/25/hard-to-test-code/" title="Previous Post: Refactoring Hard to Test Code">&laquo; Refactoring Hard to Test Code</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/11/02/refactoring-legacy-code-gilded-rose-kata/">Refactoring Legacy Code - Gilded Rose Kata</a>
      </li>
    
      <li class="post">
        <a href="/2016/08/25/hard-to-test-code/">Refactoring Hard to Test Code</a>
      </li>
    
      <li class="post">
        <a href="/2016/08/20/software-apprenticeships/">Software Apprenticeships</a>
      </li>
    
      <li class="post">
        <a href="/2016/08/04/interface-segregation/">Interface Segregation</a>
      </li>
    
      <li class="post">
        <a href="/2016/07/25/wrapping-3rd-party-code/">Wrapping 3rd Party Code</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/rickerbh">@rickerbh</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'rickerbh',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("rickerbh", , );
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <p>Follow <a href="http://twitter.com/rickerbh">@rickerbh</a></p>
  
</section>


<section class="googleplus googleplus-hidden">
  <h1>
    <a href="https://plus.google.com/103674783197570316138?rel=author">
      <img src="http://www.google.com/images/icons/ui/gprofile_button-32.png" width="32" height="32">
      Google+
    </a>
  </h1>
</section>



  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Hamish Rickerby -
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'itickedthewrongbox';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'https://hamishrickerby.com/2016/11/02/refactoring-legacy-code-gilded-rose-kata/';
        var disqus_url = 'https://hamishrickerby.com/2016/11/02/refactoring-legacy-code-gilded-rose-kata/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
